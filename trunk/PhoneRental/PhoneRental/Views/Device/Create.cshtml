@model IEnumerable<PhoneRental.Models.Device>

@{
    ViewBag.Title = "Készülékek felvétele";
    var devices = Model.ToArray();
}

<h2>Készülékek felvétele</h2>

@using (Html.BeginForm()) {
    @Html.ValidationSummary(true)

    <fieldset>
        <legend>DeviceType</legend>
        <div class="editor-label">
            <label for="DeviceTypeId">Készülék típusa</label>
        </div>
        <div class="editor-field">
            @Html.DropDownList("DeviceTypeId")
            @Html.DropDownList("AaitIdPattern")
            @Html.DropDownList("LargestId")
            <span class="field-validation-valid" data-valmsg-for="DeviceTypeId" data-valmsg-replace="true"></span>
        </div>
    </fieldset>
    
    <fieldset>
        <legend>Devices</legend>
        <table id="Devices">
            <tr>
                <th>
                    @Html.DisplayNameFor(model => model.Imei)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.AaitIdNumber)
                </th>
            <tr>
            @for (int i = 0; i < devices.Length; i++)
            {        
                <tr>
                    <td>
                        <div class="editor-field">
                            @Html.EditorFor(modelItem => devices[i].Imei)
                        </div>
                    </td>
                    <td>
                        <div class="editor-field editor-field-aait-nr">
                            <span class="AaitIdPattern"></span>_<span class="AaitIdNumber">@Html.EditorFor(modelItem => devices[i].AaitIdNumber) </span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        @Html.ValidationMessageFor(modelItem => devices[i].Imei)
                    </td>
                    <td>
                        @Html.ValidationMessageFor(modelItem => devices[i].AaitIdNumber)
                    </td>
                </tr>
            }
        </table>
    </fieldset>
    <p>
        <input type="submit" value="Mentés" />
        <input type="button" value="+" onclick="addDevice()" />
        <input type="button" value="-" onclick="removeDevice()" id="RemoveButton" style="display: none;" />
    </p>
    
}

<div>
    @Html.ActionLink("Vissza a készülékek listájára", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">
        var pattern = "";
        var largestId = 1;
        var i = @devices.Length
        
        $(document).ready(function () {
            $('#AaitIdPattern').hide();
            $('#LargestId').hide();
            $('select#DeviceTypeId').change(function () {
                deviceTypeChanged();
            });

            deviceTypeChanged();
        });

        function deviceTypeChanged () {
            var selectedVal = $("#DeviceTypeId option:selected").val();
            pattern = $('#AaitIdPattern option:[value=' + selectedVal + ']').text();
            $('.AaitIdPattern').text(pattern);

            largestId = parseInt($('#LargestId option:[value=' + selectedVal + ']').text()) || 0;
            $('.AaitIdNumber').each(function (index) {
                $(this).find('input').val(addPaddingToInt(largestId + index + 1, 3));
            });
        }

        function addDevice() {
            var newDevice =
                '<tr style="display: none;">' +
                    '<td><div class="editor-field">' +
                        '<input class="text-box single-line" data-val="true" data-val-required="A következő mező megadása kötelező: IMEI." id="devices_' + i + '__Imei" name="devices[' + i + '].Imei" type="text" value="" />' +
                    '</div></td>' +
                    '<td><div class="editor-field editor-field-aait-nr">' +
                        '<span class="AaitIdPattern">' + pattern + '</span>_<span class="AaitIdNumber"><input class="text-box single-line" data-val="true" data-val-number="The field AAIT azonosító must be a number." data-val-required="A következő mező megadása kötelező: AAIT azonosító." id="devices_' + i + '__AaitIdNumber" name="devices[' + i + '].AaitIdNumber" type="number" value="' + addPaddingToInt(largestId + i + 1, 3) + '" /></span>' +
                    '</div></td>' +
                '</tr>' +
                '<tr style="display: none;">' +
                    '<td>' +
                        '<span class="field-validation-valid" data-valmsg-for="devices[' + i + '].Imei" data-valmsg-replace="true"></span>' +
                    '</td>' +
                    '<td>' +
                        '<span class="field-validation-valid" data-valmsg-for="devices[' + i + '].AaitIdNumber" data-valmsg-replace="true"></span>' +
                    '</td>' +
                '</tr>';

            $('#Devices').append(newDevice);
            $('#Devices tr').show(500);

            reinitValidation();

            i++;

            if (i > 1) {
                $('#RemoveButton').show();
            }
        }

        function reinitValidation() {
            $("form").removeData("validator");
            $("form").removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse("form");
        }

        function removeDevice() {
            if (i > 1) {
               $('#Devices tr').last().remove();
               $('#Devices tr').last().remove();

               reinitValidation();

               i--;


                if (i <= 1) {
                    $('#RemoveButton').hide();
                }
            }
        }

        function addPaddingToInt(number, digit) {
            var retval = number;
            if (number < 0) return retval;
            if (digit < 1) return retval;

            for (var i = Math.pow(10, digit-1); i > 1; i /= 10) {
                if (number < i) retval = '0' + retval;
                else return retval;
            }

            return retval;
        }

    </script>

}
